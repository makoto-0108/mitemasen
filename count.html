<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>日々のカウント管理</title>
<style>
  body { font-family: sans-serif; max-width: 480px; margin: 20px auto; padding: 0 10px; }
  input, button { padding: 8px; margin: 5px 0; font-size: 1em; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px;}
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  button.edit { background-color: #ffcc00; border: none; cursor: pointer; border-radius: 4px; }
  #btnContainer {
    margin-top: 10px;
  }
  #btnContainer button {
    padding: 6px 12px;
    margin-right: 8px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
  }
  #show7days { background-color: #a3e4d7; color: #000; }
  #showAll { background-color: #f5b7b1; color: #000; display: none; }
</style>
</head>
<body>

<h1>日々のカウント記録</h1>

<form id="countForm">
  <label>日付: <input type="date" id="dateInput" required /></label><br />
  <label>カウント数: <input type="number" id="countInput" required min="0" /></label><br />
  <button type="submit">保存</button>
</form>

<div id="btnContainer">
  <button id="show7days">直近7日間表示</button>
  <button id="showAll">全件表示</button>
</div>

<table id="countTable">
  <thead>
    <tr><th>日付</th><th>カウント数</th><th>操作</th></tr>
  </thead>
  <tbody>
  </tbody>
</table>

<script>
  const form = document.getElementById('countForm');
  const dateInput = document.getElementById('dateInput');
  const countInput = document.getElementById('countInput');
  const tbody = document.querySelector('#countTable tbody');
  const btnShow7 = document.getElementById('show7days');
  const btnShowAll = document.getElementById('showAll');

  let counts = JSON.parse(localStorage.getItem('counts') || '{}');
  let editingDate = null;

  function parseDate(str) {
    return new Date(str + 'T00:00:00');
  }

  function renderTable(dates = null) {
    tbody.innerHTML = '';
    // 指定なければ全日付をソートして取得
    if (!dates) {
      dates = Object.keys(counts).sort();
    }
    dates.forEach(date => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${date}</td>
        <td>${counts[date]}</td>
        <td><button class="edit" data-date="${date}">編集</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderLast7Days() {
    const today = new Date();
    const sevenDaysAgo = new Date(today);
    sevenDaysAgo.setDate(today.getDate() - 6); // 今日含む7日間

    const filteredDates = Object.keys(counts)
      .filter(dateStr => {
        const d = parseDate(dateStr);
        return d >= sevenDaysAgo && d <= today;
      })
      .sort();

    renderTable(filteredDates);
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    const date = dateInput.value;
    const count = Number(countInput.value);

    if (!date) {
      alert('日付を選んでください');
      return;
    }
    if (count < 0 || isNaN(count)) {
      alert('正しいカウント数を入力してください');
      return;
    }

    counts[date] = count;
    localStorage.setItem('counts', JSON.stringify(counts));
    editingDate = null;
    form.reset();
    // 保存後は表示モードに合わせて再描画
    if (btnShow7.style.display === 'none') {
      renderTable(); // 全件表示
      btnShow7.style.display = 'inline-block';
      btnShowAll.style.display = 'none';
    } else {
      renderTable();
    }
  });

  tbody.addEventListener('click', e => {
    if (e.target.classList.contains('edit')) {
      const date = e.target.dataset.date;
      dateInput.value = date;
      countInput.value = counts[date];
      editingDate = date;
    }
  });

  btnShow7.addEventListener('click', () => {
    renderLast7Days();
    btnShow7.style.display = 'none';
    btnShowAll.style.display = 'inline-block';
  });

  btnShowAll.addEventListener('click', () => {
    renderTable();
    btnShow7.style.display = 'inline-block';
    btnShowAll.style.display = 'none';
  });

  // 初期表示は全件
  renderTable();
</script>

</body>
</html>
